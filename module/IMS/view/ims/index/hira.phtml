<?php
/**
 * @application Asgard Information System :: asgard-is
 * @version 1.0.0 devel
 * @author Joe Nilson <joenilson@gmail.com>
 */
?>
<div style='float: left;'>
<table>
    <tr style="font-weight: bold;">
        <td colspan="2"><?php echo $this->titleRiskLevel; ?></td>
        <td><?php echo $this->titleDescription; ?></td>
        <td><?php echo $this->titleCorrectionTime; ?></td>
    </tr>
<?php
echo "EL ROL ES: ".$this->userRole;
foreach ($this->hiraRiskLevel as $rlValues) {
    echo "<tr>\n";
    echo "<td class=\"risk_label_{$rlValues->id_level}\">".$rlValues->id_level."</td>\n";
    echo "<td class=\"risk_label_{$rlValues->id_level}\">".$this->hiraRiskLabels[$rlValues->id_level]['key']."</td>\n";
    echo "<td class=\"risk_text_{$rlValues->id_level}\" width=\"220\">".$this->hiraRiskLabels[$rlValues->id_level]['description']."</td>\n";
    echo "<td class=\"risk_text_{$rlValues->id_level}\">".$rlValues->min_fixtime." - ".$rlValues->max_fixtime." ".$this->timeLabels[$rlValues->format_fixtime]."</td>\n";
    echo "</tr>\n";
    $riskLevelRange[$rlValues->id_level]=array('min'=>$rlValues->min_risk,'max'=>$rlValues->max_risk);
}
?>
</table>
</div>

<div style='float: left;'>

<table border="0">
    <tr style="font-weight: bold;">
        <td colspan="2" align="center" width="100">
            <?php echo $this->titleSeverity; ?>
        </td>
        <td colspan="<?php echo count($this->frequencyLabels); ?>" align="center">
            <?php echo $this->titleMatrixRiskEval; ?>
        </td>
    </tr>
<?php
    
    foreach ($this->severityLabels as $sValues) {
        echo "<tr>\n";
        echo "<td style=\"font-weight: bold;\">".$sValues->description."</td>\n";
        echo "<td style=\"font-weight: bold;\">".$sValues->id_severity."</td>\n";
        foreach ($this->frequencyLabels as $fValues) {
            foreach ($this->hiraMatrix as $hValue) {
                if(($hValue->id_frequency == $fValues->id_frequency) AND ($hValue->id_severity == $sValues->id_severity))
                {
                    $idcls="";
                    foreach ($riskLevelRange as $key=>$range) {
                        $idcls=(($hValue->risk>=$range['min']) and ($hValue->risk<=$range['max']))?$key:$idcls;
                    }
                    echo "<td align=\"center\" class=\"risk_label_{$idcls}\">".$hValue->risk."</td>\n";
                }
            }

        }
        echo "</tr>\n";
    }
    
    echo "<tr align=\"center\" width=\"20\" style=\"font-weight: bold;\">\n";
    echo "<td colspan=\"2\" rowspan=\"3\">&nbsp;</td>";
    foreach ($this->frequencyLabels as $values) {
        echo "<td width=\"20\">".$values->id_frequency."</td>\n";
    }
    echo "</tr>\n";
    
    echo "<tr style=\"font-weight: bold;\">\n";
    foreach ($this->frequencyLabels as $values) {
        echo "<td height=\"85\"><div class=\"rotated-text-plus90\" style=\"text-align: left; position: relative;\">".$values->description."</div></td>\n";
    }
    echo "</tr>\n";
?>
    <tr>
        <td style="font-weight: bold; background: darkorange;" colspan="<? echo count($this->frequencyLabels); ?>" align="center" width="90">
            <?php echo $this->titleFrequency; ?>
        </td>
    </tr>
</table>
</div>
<script>
    
/**
* Custom function used for column renderer
* @param {Object} val
*/
function riskleveler(val) {
   if (val < 9 && val > 0) {
       return '<span style="color:red;">' + val + '</span>';
   } else if (val < 16 && val > 8) {
       return '<span style="color:#989E2A;">' + val + '</span>';
   } else if (val > 15) {
       return '<span style="color:green;">' + val + '</span>';
   }
   return val;
}

var <?php echo 'rowEditing'.$this->panelId; ?> = Ext.create('Ext.grid.plugin.RowEditing', {
    clicksToMoveEditor: 1,
    autoCancel: false
});

var <?php echo 'HIRAStore'.$this->panelId; ?> = Ext.create('Asgard.store.HiraDocuments');
<?php echo 'HIRAStore'.$this->panelId.'.load();'; ?>
    
var <?php echo 'HIRAGridPanel'.$this->panelId; ?> = Ext.create('Asgard.lib.GridPanel', {
  autoShow: true,
  autoDestroy: true,
  autoScroll: true,
  border: false,
  frame: false,
  layout: 'fit',
  store: <?php echo 'HIRAStore'.$this->panelId; ?>,
  title: '<?php echo $this->HIRAGridTitle; ?>',
  
  columns: {
      plugins: [{
            ptype: 'gridautoresizer'
            
        }
    ],
      items: [
            {text: "Id", flex:0.25, sortable: true, dataIndex: 'in_idPeligroRiesgo', hidden: true },
            {text: "Tipo Proceso", flex:1, sortable: true, filter: 'combo', dataIndex: 'in_TypeProcessDesc'},
            {text: "Proceso", flex:1, sortable: true, filter: 'combo', dataIndex: 'in_ProcessSupDesc'},
            {text: "Sub Proceso", flex:1.3, sortable: true, filter: 'combo', dataIndex: 'in_ProcesoDesc'},
            {text: "Descripción del Peligro", flex:1.5, sortable: true, filter: 'combo', dataIndex: 'in_PeligroDesc'},
            {text: "Riesgo", flex:1.2, sortable: true, filter: true, dataIndex: 'in_RiesgoDesc'},
            {text: "Evaluación IPER",
            columns: [{
                    text     : 'A',
                    width    : 50,
                    sortable : true,
                    filter: true,
                    dataIndex: 'in_EI_A',
                    renderer : riskleveler,
                    editor : { xtype: 'numberfield', allowBlank: false, minValue: 0, maxValue: 25,
                        hideTrigger: true, keyNavEnabled: false, mouseWheelEnabled: false
                    }
                }, {
                    text     : 'M',
                    width    : 50,
                    sortable : true,
                    filter: true,
                    renderer :  riskleveler,
                    dataIndex: 'in_EI_M',
                    editor : { xtype: 'numberfield', allowBlank: false, minValue: 0, maxValue: 25,
                        hideTrigger: true, keyNavEnabled: false, mouseWheelEnabled: false
                    }
                }, {
                    text     : 'B',
                    width    : 50,
                    sortable : true, 
                    filter: true,
                    renderer : riskleveler,
                    dataIndex: 'in_EI_B',
                    editor : { xtype: 'numberfield', allowBlank: false, minValue: 0, maxValue: 25,
                        hideTrigger: true, keyNavEnabled: false, mouseWheelEnabled: false
                    }
                }]
            },
            {text: "Medidas a Implementar", flex:1.2, sortable: true, filter: true, dataIndex: 'vc_MedidasControl', editor: {
                xtype: 'textareafield', allowBlank: false
            } },
            {text: "Evaluación Riesgo Residual",
            columns: [{
                    text     : 'A',
                    width    : 50,
                    sortable : true, 
                    filter: true,
                    dataIndex: 'in_ER_A',
                    renderer : riskleveler,
                    editor : { xtype: 'numberfield', allowBlank: false, minValue: 0, maxValue: 25,
                        hideTrigger: true, keyNavEnabled: false, mouseWheelEnabled: false
                    }
                }, {
                    text     : 'M',
                    width    : 50,
                    sortable : true, 
                    filter: true,
                    renderer : riskleveler,
                    dataIndex: 'in_ER_M',
                    editor : { xtype: 'numberfield', allowBlank: false, minValue: 0, maxValue: 25,
                        hideTrigger: true, keyNavEnabled: false, mouseWheelEnabled: false
                    }
                }, {
                    text     : 'B',
                    width    : 50,
                    sortable : true, 
                    filter: true,
                    renderer : riskleveler,
                    dataIndex: 'in_ER_B',
                    editor : { xtype: 'numberfield', allowBlank: false, minValue: 0, maxValue: 25,
                        hideTrigger: true, keyNavEnabled: false, mouseWheelEnabled: false
                    }
                }]
            }
        ]
    },
});
<?php
if ($this->userRole!='Viewer'){
    echo 'rowEditing'.$this->panelId.".init(HIRAGridPanel".$this->panelId.");\n\r";
    echo "HIRAGridPanel".$this->panelId.".plugins.push(rowEditing".$this->panelId.");\n\r";
}
?>
Ext.getCmp('content-panel').getActiveTab().add(<?php echo 'HIRAGridPanel'.$this->panelId; ?>);
</script>
